var w=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports);var $=w((Re,tt)=>{var{google:B}=require("googleapis"),W=B.calendar("v3"),X=B.sheets("v4"),Q=["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/spreadsheets"],D;async function Rt({serviceAccount:s}){D||(D=new B.auth.JWT(s.client_email,null,s.private_key,Q)),await D.authorize()}async function vt({spreadsheetId:s,range:t}){let e=(await X.spreadsheets.values.get({auth:D,spreadsheetId:s,range:t})).data.values,[r,...a]=e;return a.map(o=>r.reduce((i,c,S)=>(i[c]=o[S],i),{}))}async function Mt({spreadsheetId:s,range:t,values:n}){let{data:e}=await X.spreadsheets.values.append({auth:D,spreadsheetId:s,range:t,valueInputOption:"RAW",insertDataOption:"INSERT_ROWS",resource:{values:n}});return e}async function Lt({calendarIds:s,timeMin:t,timeMax:n}){let{data:{calendars:e}}=await W.freebusy.query({auth:D,requestBody:{timeMin:t,timeMax:n,timeZone:"UTC",items:s.map(r=>({id:r}))}});return e}async function Ft({calendarId:s,event:t}){let{data:n}=await W.events.insert({auth:D,calendarId:s,resource:t});return n}tt.exports={GOOGLE_SCOPES:Q,GOOGLE_AUTH:D,googleApisHandler:Rt,getGoogleSheetData:vt,appendGoogleSheetData:Mt,getGoogleCalendarsBusy:Lt,addGoogleCalendarEvent:Ft}});var j=w((ve,st)=>{var et="https://api.manychat.com",J;function Gt({apiKey:s}){J={headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}}async function Ut({subscriber_id:s,fields:t}){let n=`${et}/fb/subscriber/setCustomFields`,e=await fetch(n,{...J,method:"POST",body:JSON.stringify({subscriber_id:s,fields:t})}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}st.exports={MANYCHAT_URL:et,MANYCHAT_REQUEST:J,manychatHandler:Gt,manychatSetCustomFields:Ut}});var H=w((Me,nt)=>{var Ht=require("events"),$t=new Ht,x={};function bt(s){x=s}function Pt(){return x}nt.exports={CONFIG:x,events:$t,setConfig:bt,getConfig:Pt}});var at=w((Le,rt)=>{var y="https://api.openai.com/v1",N;function qt({apiKey:s}){N={headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"}}}async function Bt(){let s=`${y}/threads`,t=await fetch(s,{...N,method:"POST"}),n=await t.json();if(t.status!==200)throw new Error(JSON.stringify(n));return n}async function Jt({threadId:s,message:t}){let n=`${y}/threads/${s}/messages`,e=await fetch(n,{...N,method:"POST",body:JSON.stringify({role:"user",content:t})}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function jt({threadId:s,assistantId:t,instructions:n}){let e=`${y}/threads/${s}/runs`,r=await fetch(e,{...N,method:"POST",body:JSON.stringify({assistant_id:t,additional_instructions:n})}),a=await r.json();if(r.status!==200)throw new Error(JSON.stringify(a));return a}async function xt({threadId:s,runId:t}){let n=`${y}/threads/${s}/runs/${t}`,e=await fetch(n,N),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function Vt({threadId:s,runId:t}){let n=`${y}/threads/${s}/runs/${t}/cancel`,e=await fetch(n,{...N,method:"POST"}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function Yt({threadId:s,runId:t}){let n=`${y}/threads/${s}/messages?run_id=${t}`,e=await fetch(n,N),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function kt({threadId:s,runId:t,outputs:n}){let e=`${y}/threads/${s}/runs/${t}`,r=await fetch(`${e}/submit_tool_outputs`,{...N,method:"POST",body:JSON.stringify({tool_outputs:n})}),a=await r.json();if(r.status!==200)throw new Error(JSON.stringify(a));return a}rt.exports={OPENAI_URL:y,OPENAI_REQUEST:N,openAiHandler:qt,createOpenAiThread:Bt,addOpenAiThreadMessage:Jt,runOpenAiThread:jt,getOpenAiRunMessages:Yt,getOpenAiAssistantRun:xt,cancelOpenAiAssistantRun:Vt,submitOpenAiAssistantOutput:kt}});var q=w((Fe,ct)=>{var{getGoogleSheetData:ot}=$(),{events:Kt,getConfig:zt}=H();async function Zt({arguments:s}){try{let{services:t,professionals:n}=await it({arguments:s});return{services:t,professionals:n}}catch(t){return Kt.emit("error",t),{error:!0}}}async function it({arguments:s}){let{GOOGLESHEET_ID:t,GOOGLESHEET_TABS_NAME:n,GOOGLESHEET_FIELDS_NAME:e}=zt(),{professional_id:r,service_id:a}=s,o=[],i,c,S=await ot({spreadsheetId:t,range:n.SERVICES}),l=await ot({spreadsheetId:t,range:n.PROFESSSIONALS});return l=l.map(d=>(d[e.SERVICES]=d[e.SERVICES].split(","),d)),a&&(i=S.find(d=>d[e.ID]===a&&d[e.STATUS]===e.VISIBLE),i||o.push("Service ID unavailable")),r&&(c=l.find(d=>d[e.ID]===r&&d[e.STATUS]===e.VISIBLE),c||o.push("Professional ID unavailable")),i&&c&&!c[e.SERVICES].includes(i[e.ID])&&o.push("Service unavailable for this professional"),{errors:o,services:S,professionals:l,serviceSelected:i,professionalSelected:c}}ct.exports={default:Zt,handleResources:it}});var lt=w((Ge,ft)=>{var h=require("moment"),{handleResources:Wt}=q(),{getGoogleCalendarsBusy:Xt}=$(),{events:Qt,getConfig:V}=H();async function te({arguments:s}){try{let{UTC_OFFSET:t,DATE_FORMAT:n,DATE_ISO_FORMAT:e,SLOT_TIME:r,GOOGLESHEET_FIELDS_NAME:a}=V(),{date_start:o,date_end:i}=s,{errors:c,serviceSelected:S,professionalSelected:l}=await Wt({arguments:s});if(c.length)return{errors:c};let d=l[a.ID],O=l[a.CALENDAR_ID],T=Number(S[a.DURATION]),u=Number(S[a.BEFORE_DURATION]),E=h(o,n).startOf("day").utcOffset(t,!0),_=h(i,n).endOf("day").utcOffset(t,!0),I=h().utcOffset(t),G=I.clone().add(u,"minutes"),m={},R=E.clone();for(;R.isBefore(_);)m[R.format(e)]=[],R.add(1,"day");let p=await Xt({calendarIds:[O],timeMin:E.toISOString(),timeMax:_.clone().add(1,"day").toISOString()}),{errors:g,busy:v}=p[O];return c&&c.length?{errors:g}:(Object.keys(m).forEach(f=>{let A=h(f).startOf("day").utcOffset(t,!0),M=h(f).endOf("day").utcOffset(t,!0),L=ut({busy:v,dateStart:A.toISOString(),dateEnd:M.toISOString()}).filter(({start:F})=>h(F).format(e)===f);m[f]=dt({free:L,serviceDuration:T,slotDuration:r}),I.isSame(A,"date")&&(u&&I.isSame(G,"date")?m[f]=m[f].filter(F=>F>=G.format("HH:mm")):m[f]=[])}),{professionalId:d,slots:m})}catch(t){return Qt.emit("error",t),{error:!0}}}function ut({dateStart:s,dateEnd:t,busy:n}){let{UTC_OFFSET:e}=V();s=h(s).utcOffset(e),t=h(t).utcOffset(e);let r=[],a=n.length,o=h(n[0].start).utcOffset(e);s.isBefore(o)&&r.push({start:s.toISOString(),end:o.toISOString()}),n.forEach((c,S)=>{let l=n[S+1]?.start;if(!l)return;let d=h(l).utcOffset(e),O=h(c.end).utcOffset(e);O.format("HH:mm")==="23:59"&&O.add(1,"minute"),O.isBefore(d)&&r.push({start:O.toISOString(),end:d.toISOString()})});let i=h(n[a-1].end).utcOffset(e);return i.isBefore(t)&&r.push({start:i.toISOString(),end:t.toISOString()}),r}function dt({free:s,serviceDuration:t,slotDuration:n}){let{UTC_OFFSET:e}=V(),r=[];return s.forEach(a=>{let o=h(a.start),i=h(a.end);for(;o.clone().add(t,"minutes").isSameOrBefore(i);)r.push(o.utcOffset(e).format("HH:mm")),o.add(n,"minutes")}),r}function ee({time:s,round:t}){let n=s.minute(),e=Math.ceil(n/t)*t;return e>=60?s.startOf("hour").add(1,"hour"):s.minute(e).second(0)}ft.exports={default:te,getCalendarFreePeriods:ut,getCalendarFreeTimeSlots:dt,roundTime:ee}});var St=w((Ue,Et)=>{var{events:se,getConfig:ne}=H();async function re({request:s}){try{let{MANYCHAT_FIELDS_NAME:t}=ne(),{body:n}=s,e=n.custom_fields,r=e[t.CLIENT_NAME]||n.name||null,a=e[t.CLIENT_PHONE]||n.whatsapp_phone||null,o={id:n.id,confirmed:!0,name:r,phone:a};return e[t.CLIENT_NAME]||(o.confirmed=!1),e[t.CLIENT_PHONE]||(o.confirmed=!1),o}catch(t){return se.emit("error",t),{error:!0}}}Et.exports={default:re}});var Ot=w((He,_t)=>{var Y=require("moment"),{handleResources:ae}=q(),{events:oe,getConfig:ie}=H(),{manychatSetCustomFields:ce}=j(),{getGoogleCalendarsBusy:ue,appendGoogleSheetData:de,addGoogleCalendarEvent:fe}=$();async function le({request:s,arguments:t}){try{let{UTC_OFFSET:n,UTC_TIMEZONE:e,DATE_FORMAT:r,TIME_FORMAT:a,GOOGLESHEET_ID:o,GOOGLESHEET_TABS_NAME:i,GOOGLESHEET_FIELDS_NAME:c,MANYCHAT_FIELDS_ID:S,CALENDAR_TITLE:l,CALENDAR_DESCRIPTION:d,GOOGLESHEET_SCHEDULE_ORDER_FIELDS:O}=ie(),{body:T}=s,u=T.id,{client_id:E,professional_id:_,service_id:I,service_datetime:G,client_name:m,client_phone:R}=t,{errors:p,serviceSelected:g,professionalSelected:v}=await ae({arguments:t});if(p.length)return{errors:p};let f=R.replace("+",""),A=v[c.CALENDAR_ID],M=v[c.NAME],U=g[c.NAME],L=Number(g[c.DURATION]),F=Number(g[c.BEFORE_DURATION]),C=Y(G,`${r} ${a}`).utcOffset(n,!0),gt=Y().utcOffset(n);C.diff(gt,"minutes")<0&&p.push("Scheduling in the past is not allowed");let P=C.clone().add(L,"minutes"),Nt=C.clone().subtract(F,"minutes");if(C.diff(Nt,"minutes")<Number(F)&&p.push(`Minimum time is ${F} minutes in advance.`),(await ue({calendarIds:[A],timeMin:C.toISOString(),timeMax:P.toISOString()}))[A].busy.length&&p.push(`Professional unavailable at ${G} to `+P.format(`${r} ${a}`)),p.length)return{errors:p};let k={service_name:U,client_name:m,client_phone:f},Ct=l(k),wt=d(k);await fe({calendarId:A,event:{summary:Ct,description:wt,start:{dateTime:C.format(),timeZone:e},end:{dateTime:P.format(),timeZone:e}}});let K=Y().utcOffset(n).format(`${r} ${a}`),z=C.format(`${r} ${a}`),Z=P.format(`${r} ${a}`),Dt={CLIENT_ID:E,SERVICE_ID:I,PROFESSIONAL_ID:_,SERVICE_NAME:U,PROFESSIONAL_NAME:M,SERVICE_DATETIME_START:z,SERVICE_DATETIME_END:Z,CLIENT_NAME:m,CLIENT_PHONE:f,CREATED_AT:K};return await de({spreadsheetId:o,range:i.SCHEDULES,values:[O.map(yt=>Dt[yt]||"")]}),ce({subscriber_id:u,fields:[{field_id:S.CLIENT_NAME,field_name:"string",field_value:m},{field_id:S.CLIENT_PHONE,field_name:"string",field_value:f},{field_id:S.LAST_SCHEDULE_DATETIME,field_name:"string",field_value:C.toISOString()}]}),{success:!0,client_id:E,service_id:I,professional_id:_,service_name:U,professional_name:M,service_datetime_start:z,service_datetime_end:Z,client_name:m,client_phone:f,created_at:K}}catch(n){return oe.emit("error",n),{error:!0}}}_t.exports={default:le}});var mt=require("moment"),{googleApisHandler:Ee}=$(),{manychatHandler:Se,manychatSetCustomFields:_e}=j(),{events:b,setConfig:Oe,getConfig:At}=H(),{openAiHandler:me,createOpenAiThread:ht,addOpenAiThreadMessage:Tt,runOpenAiThread:he,getOpenAiAssistantRun:pt,getOpenAiRunMessages:Te,cancelOpenAiAssistantRun:pe,submitOpenAiAssistantOutput:Ae}=at(),Ie=q().default,ge=lt().default,Ne=St().default,Ce=Ot().default;async function we(s,t){try{let{UTC_OFFSET:n,DATE_FORMAT:e,TIME_FORMAT:r,SECRETS:a,OPENAI_ASSISTANT_ID:o,MANYCHAT_FIELDS_NAME:i,THREAD_EXPIRATION:c,RUN_TRIES_MAX:S}=At(),{headers:l,body:d}=s;if(l.authorization!==process.env[a.API_KEY]){t.status(401).json("Unauthorized");return}me({apiKey:process.env[a.OPENAI_KEY]}),Se({apiKey:process.env[a.MANYCHAT_KEY]}),await Ee({serviceAccount:JSON.parse(process.env[a.GOOGLEAPIS_KEY])});let O=mt().utcOffset(n),T=d.custom_fields,u=T[i.THREAD_ID],E=T[i.RUN_ID],_={thread_id:u,run_id:E};if(E){if((await pt({threadId:u,runId:E})).status!=="completed"){b.emit("success",_),t.json(_);return}let{data:A}=await Te({threadId:u,runId:E}),M=A[0]?.content[0]?.text.value;_.message=M,b.emit("success",_),t.json(_);return}let I=T[i.LAST_MESSAGE_DATETIME];(I?O.diff(mt(I),"h"):0)>c&&(u=void 0),u||(u=(await ht()).id);let m=T[i.LAST_MESSAGE_TEXT];try{await Tt({threadId:u,message:m})}catch{u=(await ht()).id,await Tt({threadId:u,message:m})}_.thread_id=u,_.last_message_datetime=O.toISOString();let R="Data e hora atual de refer\xEAncia: "+O.format(`${e} ${r}`);E=(await he({threadId:u,instructions:R,assistantId:o})).id,_.run_id=E,t.json(_);let g=!0,v=0;for(;g;){v++;let f=await pt({threadId:u,runId:E});switch(f.status){case"requires_action":let A=f.required_action.submit_tool_outputs.tool_calls,U=(await Promise.all(A.map(L=>It({request:s,run:f,call:L})))).map(({callback:L})=>L);await Ae({threadId:u,runId:E,outputs:U});break;case"completed":g=!1;break;case"cancelled":g=!1;return;default:break}if(v===S)try{await pe({threadId:u,runId:E})}catch{}}b.emit("success",_)}catch(n){b.emit("error",n),t._headerSent||t.status(500).json("See logs")}}async function It({request:s,run:t,call:n}){let{FUNCTIONS_MAP:e}=At(),r={...e};e.GET_CATALOG&&(r[e.GET_CATALOG]=Ie),e.GET_CALENDAR&&(r[e.GET_CALENDAR]=ge),e.GET_CUSTOMER&&(r[e.GET_CUSTOMER]=Ne),e.SEND_SCHEDULE&&(r[e.SEND_SCHEDULE]=Ce);let{body:a}=s,{name:o,arguments:i}=n.function;i=JSON.parse(i);let c=r[o];if(!c)throw new Error("Function not found");let l=await c({request:s,run:t,name:o,arguments:i,setFields:O=>_e({subscriber_id:a.id,fields:O.map(([T,u,E])=>({field_id:T,field_name:u,field_value:E}))})}),d={tool_call_id:n.id,output:JSON.stringify(l)};return{call:n,output:l,callback:d}}module.exports={assistantEvents:b,assistantConfig:Oe,assistantHandler:we,assistantFunctionHandler:It};
