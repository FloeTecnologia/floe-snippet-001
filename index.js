var v=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports);var Y=v((Te,k)=>{k.exports={SLOT_TIME:30,GOOGLESHEET_TABS_NAME:{SERVICES:"Servi\xE7os!A:F",PROFESSSIONALS:"Profissionais!A:E",SCHEDULES:"Agendamentos!A:J"},GOOGLESHEET_FIELDS_NAME:{ID:"Identifica\xE7\xE3o",STATUS:"Situa\xE7\xE3o",NAME:"Nome",VISIBLE:"Vis\xEDvel",CALENDAR_ID:"Calend\xE1rio ID",SERVICES:"Servi\xE7os ID",DURATION:"Dura\xE7\xE3o (min)",BEFORE_DURATION:"Anteced\xEAncia (min)"},GOOGLESHEET_SCHEDULE_ORDER_FIELDS:["CLIENT_ID","SERVICE_ID","PROFESSIONAL_ID","SERVICE_NAME","PROFESSIONAL_NAME","SERVICE_DATETIME_START","SERVICE_DATETIME_END","CLIENT_NAME","CLIENT_PHONE","CREATED_AT"],CALENDAR_TITLE:"[CLIENT_NAME] | [SERVICE_NAME]",CALENDAR_DESCRIPTION:"Servi\xE7o: [SERVICE_NAME]\nCliente Nome: [CLIENT_NAME]\nCliente Telefone: [CLIENT_PHONE]"}});var H=v((me,z)=>{async function ce(t){let{events:r}=t;try{let{services:n,professionals:s}=await j(t);return{services:n,professionals:s}}catch(n){return r.emit("error",JSON.stringify(n)),{error:!0}}}async function j({config:t,services:r,arguments:n}){let{GOOGLESHEET_ID:s,GOOGLESHEET_TABS_NAME:a,GOOGLESHEET_FIELDS_NAME:e}=t,{professional_id:u,service_id:i}=n,c=[],E,S,_=await r.googleapis.getGoogleSheetData({spreadsheetId:s,range:a.SERVICES}),f=await r.googleapis.getGoogleSheetData({spreadsheetId:s,range:a.PROFESSSIONALS});return f=f.map(o=>(o[e.SERVICES]=o[e.SERVICES].split(","),o)),i&&(E=_.find(o=>o[e.ID]===i&&o[e.STATUS]===e.VISIBLE),E||c.push("Service ID unavailable")),u&&(S=f.find(o=>o[e.ID]===u&&o[e.STATUS]===e.VISIBLE),S||c.push("Professional ID unavailable")),E&&S&&!S[e.SERVICES].includes(E[e.ID])&&c.push("Service unavailable for this professional"),{errors:c,services:_,professionals:f,serviceSelected:E,professionalSelected:S}}z.exports={default:ce,handleResources:j}});var X=v((Ne,W)=>{var d=require("moment"),{handleResources:Se}=H();async function ue(t){let{config:r,services:n,arguments:s,events:a}=t;try{let{UTC_OFFSET:e,DATE_FORMAT:u,DATE_ISO_FORMAT:i,SLOT_TIME:c,GOOGLESHEET_FIELDS_NAME:E}=r,{date_start:S,date_end:_}=s,{errors:f,serviceSelected:o,professionalSelected:D}=await Se(t);if(f.length)return{errors:f};let P=D[E.ID],M=D[E.CALENDAR_ID],B=Number(o[E.DURATION]),F=Number(o[E.BEFORE_DURATION]),y=d(S,u).startOf("day").utcOffset(e,!0),C=d(_,u).endOf("day").utcOffset(e,!0),A=d().utcOffset(e),g=A.clone().add(F,"minutes"),l={},T=y.clone();for(;T.isBefore(C);)l[T.format(i)]=[],T.add(1,"day");let V=await n.googleapis.getGoogleCalendarsBusy({calendarIds:[M],timeMin:y.toISOString(),timeMax:C.clone().add(1,"day").toISOString()}),{errors:O,busy:L}=V[M];return f&&f.length?{errors:O}:(Object.keys(l).forEach(I=>{let m=d(I).startOf("day").utcOffset(e,!0),R=d(I).endOf("day").utcOffset(e,!0),h=K({config:r,busy:L,dateStart:m.toISOString(),dateEnd:R.toISOString()}).filter(({start:p})=>d(p).format(i)===I);l[I]=Q({config:r,free:h,serviceDuration:B,slotDuration:c}),A.isSame(m,"date")&&(F&&A.isSame(g,"date")?l[I]=l[I].filter(p=>p>=g.format("HH:mm")):l[I]=[])}),{professionalId:P,slots:l})}catch(e){return a.emit("error",JSON.stringify(e)),{error:!0}}}function K({config:t,dateStart:r,dateEnd:n,busy:s}){let{UTC_OFFSET:a}=t;r=d(r).utcOffset(a),n=d(n).utcOffset(a);let e=[],u=s.length,i=d(s[0].start).utcOffset(a);r.isBefore(i)&&e.push({start:r.toISOString(),end:i.toISOString()}),s.forEach((E,S)=>{let _=s[S+1]?.start;if(!_)return;let f=d(_).utcOffset(a),o=d(E.end).utcOffset(a);o.format("HH:mm")==="23:59"&&o.add(1,"minute"),o.isBefore(f)&&e.push({start:o.toISOString(),end:f.toISOString()})});let c=d(s[u-1].end).utcOffset(a);return c.isBefore(n)&&e.push({start:c.toISOString(),end:n.toISOString()}),e}function Q({config:t,free:r,serviceDuration:n,slotDuration:s}){let{UTC_OFFSET:a}=t,e=[];return r.forEach(u=>{let i=d(u.start),c=d(u.end);for(;i.clone().add(n,"minutes").isSameOrBefore(c);)e.push(i.utcOffset(a).format("HH:mm")),i.add(s,"minutes")}),e}function fe({time:t,round:r}){let n=t.minute(),s=Math.ceil(n/r)*r;return s>=60?t.startOf("hour").add(1,"hour"):t.minute(s).second(0)}W.exports={default:ue,getCalendarFreePeriods:K,getCalendarFreeTimeSlots:Q,roundTime:fe}});var te=v((Ae,ee)=>{async function de({config:t,request:r}){try{let{MANYCHAT_FIELDS_NAME:n}=t,{body:s}=r,a=s.custom_fields,e=a[n.CLIENT_NAME],u=a[n.CLIENT_PHONE]||s.whatsapp_phone,i=e&&u;return{id:s.id,confirmed:i,name:e,phone:u}}catch(n){return events.emit("error",JSON.stringify(n)),{error:!0}}}ee.exports={default:de}});var ne=v((De,re)=>{var q=require("moment"),{handleResources:le}=H();async function Ie(t){let{config:r,services:n,request:s,arguments:a,events:e}=t;try{let b=function($){return $.replace(/\[CLIENT_NAME\]/g,T).replace(/\[CLIENT_PHONE\]/g,m).replace(/\[SERVICE_NAME\]/g,h)};var u=b;let{UTC_OFFSET:i,UTC_TIMEZONE:c,DATE_FORMAT:E,TIME_FORMAT:S,GOOGLESHEET_ID:_,GOOGLESHEET_TABS_NAME:f,GOOGLESHEET_FIELDS_NAME:o,MANYCHAT_FIELDS_ID:D,CALENDAR_TITLE:P,CALENDAR_DESCRIPTION:M,GOOGLESHEET_SCHEDULE_ORDER_FIELDS:B}=r,{body:F}=s,y=F.id,{client_id:C,professional_id:A,service_id:g,service_datetime:l,client_name:T,client_phone:V}=a,{errors:O,serviceSelected:L,professionalSelected:I}=await le(t);if(O.length)return{errors:O};let m=V.replace("+",""),R=I[o.CALENDAR_ID],U=I[o.NAME],h=L[o.NAME],p=Number(L[o.DURATION]),w=Number(L[o.BEFORE_DURATION]),N=q(l,`${E} ${S}`).utcOffset(i,!0),se=q().utcOffset(i);N.diff(se,"minutes")<0&&O.push("Scheduling in the past is not allowed");let G=N.clone().add(p,"minutes"),oe=N.clone().subtract(w,"minutes");if(N.diff(oe,"minutes")<Number(w)&&O.push(`Minimum time is ${w} minutes in advance.`),(await n.googleapis.getGoogleCalendarsBusy({calendarIds:[R],timeMin:N.toISOString(),timeMax:G.toISOString()}))[R].busy.length&&O.push(`Professional unavailable at ${l} to `+G.format(`${E} ${S}`)),O.length)return{errors:O};let ie=b(P),ae=b(M);await n.googleapis.addGoogleCalendarEvent({calendarId:R,event:{summary:ie,description:ae,start:{dateTime:N.format(),timeZone:c},end:{dateTime:G.format(),timeZone:c}}});let x=q().utcOffset(i).format(`${E} ${S}`),J=N.format(`${E} ${S}`),Z=G.format(`${E} ${S}`),Ee={CLIENT_ID:C,SERVICE_ID:g,PROFESSIONAL_ID:A,SERVICE_NAME:h,PROFESSIONAL_NAME:U,SERVICE_DATETIME_START:J,SERVICE_DATETIME_END:Z,CLIENT_NAME:T,CLIENT_PHONE:m,CREATED_AT:x};return await n.googleapis.appendGoogleSheetData({spreadsheetId:_,range:f.SCHEDULES,values:[B.map($=>Ee[$]||"")]}),n.manychat.manychatSetCustomFields({subscriber_id:y,fields:[{field_id:D.CLIENT_NAME,field_name:"string",field_value:T},{field_id:D.CLIENT_PHONE,field_name:"string",field_value:m}]}),{success:!0,client_id:C,service_id:g,professional_id:A,service_name:h,professional_name:U,service_datetime_start:J,service_datetime_end:Z,client_name:T,client_phone:m,created_at:x}}catch(i){return e.emit("error",JSON.stringify(i)),{error:!0}}}re.exports={default:Ie}});module.exports={config:Y(),functions:function(t){return{[t.GET_CATALOG]:H().default,[t.GET_CALENDAR]:X().default,[t.GET_CUSTOMER]:te().default,[t.SEND_SCHEDULE]:ne().default}}};
