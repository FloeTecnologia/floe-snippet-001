var C=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports);var $=C((Me,tt)=>{var{google:B}=require("googleapis"),W=B.calendar("v3"),X=B.sheets("v4"),Q=["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/spreadsheets"],w;async function Rt({serviceAccount:s}){w||(w=new B.auth.JWT(s.client_email,null,s.private_key,Q)),await w.authorize()}async function vt({spreadsheetId:s,range:t}){let e=(await X.spreadsheets.values.get({auth:w,spreadsheetId:s,range:t})).data.values,[r,...a]=e;return a.map(o=>r.reduce((i,c,S)=>(i[c]=o[S],i),{}))}async function Mt({spreadsheetId:s,range:t,values:n}){let{data:e}=await X.spreadsheets.values.append({auth:w,spreadsheetId:s,range:t,valueInputOption:"RAW",insertDataOption:"INSERT_ROWS",resource:{values:n}});return e}async function Lt({calendarIds:s,timeMin:t,timeMax:n}){let{data:{calendars:e}}=await W.freebusy.query({auth:w,requestBody:{timeMin:t,timeMax:n,timeZone:"UTC",items:s.map(r=>({id:r}))}});return e}async function Ft({calendarId:s,event:t}){let{data:n}=await W.events.insert({auth:w,calendarId:s,resource:t});return n}tt.exports={GOOGLE_SCOPES:Q,GOOGLE_AUTH:w,googleApisHandler:Rt,getGoogleSheetData:vt,appendGoogleSheetData:Mt,getGoogleCalendarsBusy:Lt,addGoogleCalendarEvent:Ft}});var j=C((Le,st)=>{var et="https://api.manychat.com",J;function Gt({apiKey:s}){J={headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}}async function Ut({subscriber_id:s,fields:t}){let n=`${et}/fb/subscriber/setCustomFields`,e=await fetch(n,{...J,method:"POST",body:JSON.stringify({subscriber_id:s,fields:t})}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}st.exports={MANYCHAT_URL:et,MANYCHAT_REQUEST:J,manychatHandler:Gt,manychatSetCustomFields:Ut}});var H=C((Fe,nt)=>{var Ht=require("events"),$t=new Ht,x={};function bt(s){x=s}function Pt(){return x}nt.exports={CONFIG:x,events:$t,setConfig:bt,getConfig:Pt}});var at=C((Ge,rt)=>{var y="https://api.openai.com/v1",N;function qt({apiKey:s}){N={headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"}}}async function Bt(){let s=`${y}/threads`,t=await fetch(s,{...N,method:"POST"}),n=await t.json();if(t.status!==200)throw new Error(JSON.stringify(n));return n}async function Jt({threadId:s,message:t}){let n=`${y}/threads/${s}/messages`,e=await fetch(n,{...N,method:"POST",body:JSON.stringify({role:"user",content:t})}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function jt({threadId:s,assistantId:t,instructions:n}){let e=`${y}/threads/${s}/runs`,r=await fetch(e,{...N,method:"POST",body:JSON.stringify({assistant_id:t,additional_instructions:n})}),a=await r.json();if(r.status!==200)throw new Error(JSON.stringify(a));return a}async function xt({threadId:s,runId:t}){let n=`${y}/threads/${s}/runs/${t}`,e=await fetch(n,N),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function Vt({threadId:s,runId:t}){let n=`${y}/threads/${s}/runs/${t}/cancel`,e=await fetch(n,{...N,method:"POST"}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function Yt({threadId:s,runId:t}){let n=`${y}/threads/${s}/messages?run_id=${t}`,e=await fetch(n,N),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function kt({threadId:s,runId:t,outputs:n}){let e=`${y}/threads/${s}/runs/${t}`,r=await fetch(`${e}/submit_tool_outputs`,{...N,method:"POST",body:JSON.stringify({tool_outputs:n})}),a=await r.json();if(r.status!==200)throw new Error(JSON.stringify(a));return a}rt.exports={OPENAI_URL:y,OPENAI_REQUEST:N,openAiHandler:qt,createOpenAiThread:Bt,addOpenAiThreadMessage:Jt,runOpenAiThread:jt,getOpenAiRunMessages:Yt,getOpenAiAssistantRun:xt,cancelOpenAiAssistantRun:Vt,submitOpenAiAssistantOutput:kt}});var q=C((Ue,ct)=>{var{getGoogleSheetData:ot}=$(),{events:Kt,getConfig:zt}=H();async function Zt({arguments:s}){try{let{services:t,professionals:n}=await it({arguments:s});return{services:t,professionals:n}}catch(t){return Kt.emit("error",t),{error:!0}}}async function it({arguments:s}){let{GOOGLESHEET_ID:t,GOOGLESHEET_TABS_NAME:n,GOOGLESHEET_FIELDS_NAME:e}=zt(),{professional_id:r,service_id:a}=s,o=[],i,c,S=await ot({spreadsheetId:t,range:n.SERVICES}),O=await ot({spreadsheetId:t,range:n.PROFESSSIONALS});return O=O.map(l=>(l[e.SERVICES]=l[e.SERVICES].split(","),l)),a&&(i=S.find(l=>l[e.ID]===a&&l[e.STATUS]===e.VISIBLE),i||o.push("Service ID unavailable")),r&&(c=O.find(l=>l[e.ID]===r&&l[e.STATUS]===e.VISIBLE),c||o.push("Professional ID unavailable")),i&&c&&!c[e.SERVICES].includes(i[e.ID])&&o.push("Service unavailable for this professional"),{errors:o,services:S,professionals:O,serviceSelected:i,professionalSelected:c}}ct.exports={default:Zt,handleResources:it}});var lt=C((He,ft)=>{var h=require("moment"),{handleResources:Wt}=q(),{getGoogleCalendarsBusy:Xt}=$(),{events:Qt,getConfig:V}=H();async function te({arguments:s}){try{let{UTC_OFFSET:t,DATE_FORMAT:n,DATE_ISO_FORMAT:e,SLOT_TIME:r,GOOGLESHEET_FIELDS_NAME:a}=V(),{date_start:o,date_end:i}=s,{errors:c,serviceSelected:S,professionalSelected:O}=await Wt({arguments:s});if(c.length)return{errors:c};let l=O[a.ID],_=O[a.CALENDAR_ID],T=Number(S[a.DURATION]),u=Number(S[a.BEFORE_DURATION]),d=h(o,n).startOf("day").utcOffset(t,!0),f=h(i,n).endOf("day").utcOffset(t,!0),p=h().utcOffset(t),G=p.clone().add(u,"minutes"),m={},R=d.clone();for(;R.isBefore(f);)m[R.format(e)]=[],R.add(1,"day");let A=await Xt({calendarIds:[_],timeMin:d.toISOString(),timeMax:f.clone().add(1,"day").toISOString()}),{errors:g,busy:v}=A[_];return c&&c.length?{errors:g}:(Object.keys(m).forEach(E=>{let I=h(E).startOf("day").utcOffset(t,!0),M=h(E).endOf("day").utcOffset(t,!0),L=ut({busy:v,dateStart:I.toISOString(),dateEnd:M.toISOString()}).filter(({start:F})=>h(F).format(e)===E);m[E]=dt({free:L,serviceDuration:T,slotDuration:r}),p.isSame(I,"date")&&(u&&p.isSame(G,"date")?m[E]=m[E].filter(F=>F>=G.format("HH:mm")):m[E]=[])}),{professionalId:l,slots:m})}catch(t){return Qt.emit("error",t),{error:!0}}}function ut({dateStart:s,dateEnd:t,busy:n}){let{UTC_OFFSET:e}=V();s=h(s).utcOffset(e),t=h(t).utcOffset(e);let r=[],a=n.length,o=h(n[0].start).utcOffset(e);s.isBefore(o)&&r.push({start:s.toISOString(),end:o.toISOString()}),n.forEach((c,S)=>{let O=n[S+1]?.start;if(!O)return;let l=h(O).utcOffset(e),_=h(c.end).utcOffset(e);_.format("HH:mm")==="23:59"&&_.add(1,"minute"),_.isBefore(l)&&r.push({start:_.toISOString(),end:l.toISOString()})});let i=h(n[a-1].end).utcOffset(e);return i.isBefore(t)&&r.push({start:i.toISOString(),end:t.toISOString()}),r}function dt({free:s,serviceDuration:t,slotDuration:n}){let{UTC_OFFSET:e}=V(),r=[];return s.forEach(a=>{let o=h(a.start),i=h(a.end);for(;o.clone().add(t,"minutes").isSameOrBefore(i);)r.push(o.utcOffset(e).format("HH:mm")),o.add(n,"minutes")}),r}function ee({time:s,round:t}){let n=s.minute(),e=Math.ceil(n/t)*t;return e>=60?s.startOf("hour").add(1,"hour"):s.minute(e).second(0)}ft.exports={default:te,getCalendarFreePeriods:ut,getCalendarFreeTimeSlots:dt,roundTime:ee}});var St=C(($e,Et)=>{var{events:se,getConfig:ne}=H();async function re({request:s}){try{let{MANYCHAT_FIELDS_NAME:t}=ne(),{body:n}=s,e=n.custom_fields,r=e[t.CLIENT_NAME]||n.name||null,a=e[t.CLIENT_PHONE]||n.whatsapp_phone||null,o={id:n.id,confirmed:!0,name:r,phone:a};return e[t.CLIENT_NAME]||(o.confirmed=!1),e[t.CLIENT_PHONE]||(o.confirmed=!1),o}catch(t){return se.emit("error",t),{error:!0}}}Et.exports={default:re}});var Ot=C((be,_t)=>{var Y=require("moment"),{handleResources:ae}=q(),{events:oe,getConfig:ie}=H(),{manychatSetCustomFields:ce}=j(),{getGoogleCalendarsBusy:ue,appendGoogleSheetData:de,addGoogleCalendarEvent:fe}=$();async function le({request:s,arguments:t}){try{let{UTC_OFFSET:n,UTC_TIMEZONE:e,DATE_FORMAT:r,TIME_FORMAT:a,GOOGLESHEET_ID:o,GOOGLESHEET_TABS_NAME:i,GOOGLESHEET_FIELDS_NAME:c,MANYCHAT_FIELDS_ID:S,CALENDAR_TITLE:O,CALENDAR_DESCRIPTION:l,GOOGLESHEET_SCHEDULE_ORDER_FIELDS:_}=ie(),{body:T}=s,u=T.id,{client_id:d,professional_id:f,service_id:p,service_datetime:G,client_name:m,client_phone:R}=t,{errors:A,serviceSelected:g,professionalSelected:v}=await ae({arguments:t});if(A.length)return{errors:A};let E=R.replace("+",""),I=v[c.CALENDAR_ID],M=v[c.NAME],U=g[c.NAME],L=Number(g[c.DURATION]),F=Number(g[c.BEFORE_DURATION]),D=Y(G,`${r} ${a}`).utcOffset(n,!0),gt=Y().utcOffset(n);D.diff(gt,"minutes")<0&&A.push("Scheduling in the past is not allowed");let P=D.clone().add(L,"minutes"),Nt=D.clone().subtract(F,"minutes");if(D.diff(Nt,"minutes")<Number(F)&&A.push(`Minimum time is ${F} minutes in advance.`),(await ue({calendarIds:[I],timeMin:D.toISOString(),timeMax:P.toISOString()}))[I].busy.length&&A.push(`Professional unavailable at ${G} to `+P.format(`${r} ${a}`)),A.length)return{errors:A};let k={service_name:U,client_name:m,client_phone:E},Dt=O(k),Ct=l(k);await fe({calendarId:I,event:{summary:Dt,description:Ct,start:{dateTime:D.format(),timeZone:e},end:{dateTime:P.format(),timeZone:e}}});let K=Y().utcOffset(n).format(`${r} ${a}`),z=D.format(`${r} ${a}`),Z=P.format(`${r} ${a}`),wt={CLIENT_ID:d,SERVICE_ID:p,PROFESSIONAL_ID:f,SERVICE_NAME:U,PROFESSIONAL_NAME:M,SERVICE_DATETIME_START:z,SERVICE_DATETIME_END:Z,CLIENT_NAME:m,CLIENT_PHONE:E,CREATED_AT:K};return await de({spreadsheetId:o,range:i.SCHEDULES,values:[_.map(yt=>wt[yt]||"")]}),ce({subscriber_id:u,fields:[{field_id:S.CLIENT_NAME,field_name:"string",field_value:m},{field_id:S.CLIENT_PHONE,field_name:"string",field_value:E},{field_id:S.LAST_SCHEDULE_DATETIME,field_name:"string",field_value:D.toISOString()}]}),{success:!0,client_id:d,service_id:p,professional_id:f,service_name:U,professional_name:M,service_datetime_start:z,service_datetime_end:Z,client_name:m,client_phone:E,created_at:K}}catch(n){return oe.emit("error",n),{error:!0}}}_t.exports={default:le}});var mt=require("moment"),{googleApisHandler:Ee,getGoogleSheetData:Se,appendGoogleSheetData:_e}=$(),{manychatHandler:Oe,manychatSetCustomFields:me}=j(),{events:b,setConfig:he,getConfig:At}=H(),{openAiHandler:pe,createOpenAiThread:ht,addOpenAiThreadMessage:pt,runOpenAiThread:Te,getOpenAiAssistantRun:Tt,getOpenAiRunMessages:Ae,cancelOpenAiAssistantRun:Ie,submitOpenAiAssistantOutput:ge}=at(),Ne=q().default,De=lt().default,Ce=St().default,we=Ot().default;async function ye(s,t){try{let{UTC_OFFSET:n,DATE_FORMAT:e,TIME_FORMAT:r,SECRETS:a,OPENAI_ASSISTANT_ID:o,MANYCHAT_FIELDS_NAME:i,THREAD_EXPIRATION:c,RUN_TRIES_MAX:S}=At(),{headers:O,body:l}=s;if(O.authorization!==process.env[a.API_KEY]){t.status(401).json("Unauthorized");return}pe({apiKey:process.env[a.OPENAI_KEY]}),Oe({apiKey:process.env[a.MANYCHAT_KEY]}),await Ee({serviceAccount:JSON.parse(process.env[a.GOOGLEAPIS_KEY])});let _=mt().utcOffset(n),T=l.custom_fields,u=T[i.THREAD_ID],d=T[i.RUN_ID],f={thread_id:u,run_id:d};if(d){if((await Tt({threadId:u,runId:d})).status!=="completed"){b.emit("success",f),t.json(f);return}let{data:I}=await Ae({threadId:u,runId:d}),M=I[0]?.content[0]?.text.value;f.message=M,b.emit("success",f),t.json(f);return}let p=T[i.LAST_MESSAGE_DATETIME];(p?_.diff(mt(p),"h"):0)>c&&(u=void 0),u||(u=(await ht()).id);let m=T[i.LAST_MESSAGE_TEXT];try{await pt({threadId:u,message:m})}catch{u=(await ht()).id,await pt({threadId:u,message:m})}f.thread_id=u,f.last_message_datetime=_.toISOString();let R="Data e hora atual de refer\xEAncia: "+_.format(`${e} ${r}`);d=(await Te({threadId:u,instructions:R,assistantId:o})).id,f.run_id=d,t.json(f);let g=!0,v=0;for(;g;){v++;let E=await Tt({threadId:u,runId:d});switch(E.status){case"requires_action":let I=E.required_action.submit_tool_outputs.tool_calls,U=(await Promise.all(I.map(L=>It({request:s,run:E,call:L})))).map(({callback:L})=>L);await ge({threadId:u,runId:d,outputs:U});break;case"completed":g=!1;break;case"cancelled":g=!1;return;default:break}if(v===S)try{await Ie({threadId:u,runId:d})}catch{}}b.emit("success",f)}catch(n){b.emit("error",n),t._headerSent||t.status(500).json("See logs")}}async function It({request:s,run:t,call:n}){let{FUNCTIONS_MAP:e}=At(),r={...e};e.GET_CATALOG&&(r[e.GET_CATALOG]=Ne),e.GET_CALENDAR&&(r[e.GET_CALENDAR]=De),e.GET_CUSTOMER&&(r[e.GET_CUSTOMER]=Ce),e.SEND_SCHEDULE&&(r[e.SEND_SCHEDULE]=we);let{body:a}=s,{name:o,arguments:i}=n.function;i=JSON.parse(i);let c=r[o];if(!c)throw new Error("Function not found");let _=await c({request:s,run:t,name:o,arguments:i,setFields:u=>me({subscriber_id:a.id,fields:u.map(([d,f,p])=>({field_id:d,field_name:f,field_value:p}))}),getSheetData:(u,d)=>Se({spreadsheetId:u,range:d}),appendSheetData:(u,d,f)=>_e({spreadsheetId:u,range:d,values:f})}),T={tool_call_id:n.id,output:JSON.stringify(_)};return{call:n,output:_,callback:T}}module.exports={assistantEvents:b,assistantConfig:he,assistantHandler:ye,assistantFunctionHandler:It};
