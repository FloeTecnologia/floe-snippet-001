var C=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports);var $=C((Re,tt)=>{var{google:B}=require("googleapis"),Z=B.calendar("v3"),W=B.sheets("v4"),Q=["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/spreadsheets"],y;async function Rt({serviceAccount:s}){y||(y=new B.auth.JWT(s.client_email,null,s.private_key,Q)),await y.authorize()}async function vt({spreadsheetId:s,range:t}){let e=(await W.spreadsheets.values.get({auth:y,spreadsheetId:s,range:t})).data.values,[r,...a]=e;return a.map(o=>r.reduce((i,c,S)=>(i[c]=o[S],i),{}))}async function Lt({spreadsheetId:s,range:t,values:n}){let{data:e}=await W.spreadsheets.values.append({auth:y,spreadsheetId:s,range:t,valueInputOption:"RAW",insertDataOption:"INSERT_ROWS",resource:{values:n}});return e}async function Mt({calendarIds:s,timeMin:t,timeMax:n}){let{data:{calendars:e}}=await Z.freebusy.query({auth:y,requestBody:{timeMin:t,timeMax:n,timeZone:"UTC",items:s.map(r=>({id:r}))}});return e}async function Ft({calendarId:s,event:t}){let{data:n}=await Z.events.insert({auth:y,calendarId:s,resource:t});return n}tt.exports={GOOGLE_SCOPES:Q,GOOGLE_AUTH:y,googleApisHandler:Rt,getGoogleSheetData:vt,appendGoogleSheetData:Lt,getGoogleCalendarsBusy:Mt,addGoogleCalendarEvent:Ft}});var j=C((ve,st)=>{var et="https://api.manychat.com",J;function Gt({apiKey:s}){J={headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}}async function Ut({subscriber_id:s,fields:t}){let n=`${et}/fb/subscriber/setCustomFields`,e=await fetch(n,{...J,method:"POST",body:JSON.stringify({subscriber_id:s,fields:t})}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}st.exports={MANYCHAT_URL:et,MANYCHAT_REQUEST:J,manychatHandler:Gt,manychatSetCustomFields:Ut}});var H=C((Le,nt)=>{var Ht=require("events"),$t=new Ht,x={};function bt(s){x=s}function Pt(){return x}nt.exports={CONFIG:x,events:$t,setConfig:bt,getConfig:Pt}});var at=C((Me,rt)=>{var D="https://api.openai.com/v1",N;function qt({apiKey:s}){N={headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"}}}async function Bt(){let s=`${D}/threads`,t=await fetch(s,{...N,method:"POST"}),n=await t.json();if(t.status!==200)throw new Error(JSON.stringify(n));return n}async function Jt({threadId:s,message:t}){let n=`${D}/threads/${s}/messages`,e=await fetch(n,{...N,method:"POST",body:JSON.stringify({role:"user",content:t})}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function jt({threadId:s,assistantId:t,instructions:n}){let e=`${D}/threads/${s}/runs`,r=await fetch(e,{...N,method:"POST",body:JSON.stringify({assistant_id:t,additional_instructions:n})}),a=await r.json();if(r.status!==200)throw new Error(JSON.stringify(a));return a}async function xt({threadId:s,runId:t}){let n=`${D}/threads/${s}/runs/${t}`,e=await fetch(n,N),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function Vt({threadId:s,runId:t}){let n=`${D}/threads/${s}/runs/${t}/cancel`,e=await fetch(n,{...N,method:"POST"}),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function kt({threadId:s,runId:t}){let n=`${D}/threads/${s}/messages?run_id=${t}`,e=await fetch(n,N),r=await e.json();if(e.status!==200)throw new Error(JSON.stringify(r));return r}async function Yt({threadId:s,runId:t,outputs:n}){let e=`${D}/threads/${s}/runs/${t}`,r=await fetch(`${e}/submit_tool_outputs`,{...N,method:"POST",body:JSON.stringify({tool_outputs:n})}),a=await r.json();if(r.status!==200)throw new Error(JSON.stringify(a));return a}rt.exports={OPENAI_URL:D,OPENAI_REQUEST:N,openAiHandler:qt,createOpenAiThread:Bt,addOpenAiThreadMessage:Jt,runOpenAiThread:jt,getOpenAiRunMessages:kt,getOpenAiAssistantRun:xt,cancelOpenAiAssistantRun:Vt,submitOpenAiAssistantOutput:Yt}});var q=C((Fe,ct)=>{var{getGoogleSheetData:ot}=$(),{events:Kt,getConfig:zt}=H();async function Xt({arguments:s}){try{let{services:t,professionals:n}=await it({arguments:s});return{services:t,professionals:n}}catch(t){return Kt.emit("error",t),{error:!0}}}async function it({arguments:s}){let{GOOGLESHEET_ID:t,GOOGLESHEET_TABS:n,GOOGLESHEET_FIELDS:e}=zt(),{professional_id:r,service_id:a}=s,o=[],i,c,S=await ot({spreadsheetId:t,range:n.SERVICES}),l=await ot({spreadsheetId:t,range:n.PROFESSSIONALS});return l=l.map(d=>(d[e.SERVICES]=d[e.SERVICES].split(","),d)),a&&(i=S.find(d=>d[e.ID]===a&&d[e.STATUS]===e.VISIBLE),i||o.push("Service ID unavailable")),r&&(c=l.find(d=>d[e.ID]===r&&d[e.STATUS]===e.VISIBLE),c||o.push("Professional ID unavailable")),i&&c&&!c[e.SERVICES].includes(i[e.ID])&&o.push("Service unavailable for this professional"),{errors:o,services:S,professionals:l,serviceSelected:i,professionalSelected:c}}ct.exports={default:Xt,handleResources:it}});var lt=C((Ge,ft)=>{var h=require("moment"),{handleResources:Zt}=q(),{getGoogleCalendarsBusy:Wt}=$(),{events:Qt,getConfig:V}=H();async function te({arguments:s}){try{let{UTC_OFFSET:t,DATE_FORMAT:n,DATE_ISO_FORMAT:e,SLOT_TIME:r,GOOGLESHEET_FIELDS:a}=V(),{date_start:o,date_end:i}=s,{errors:c,serviceSelected:S,professionalSelected:l}=await Zt({arguments:s});if(c.length)return{errors:c};let d=l[a.ID],_=l[a.CALENDAR_ID],T=Number(S[a.DURATION]),u=Number(S[a.BEFORE_DURATION]),E=h(o,n).startOf("day").utcOffset(t,!0),O=h(i,n).endOf("day").utcOffset(t,!0),I=h().utcOffset(t),G=I.clone().add(u,"minutes"),m={},R=E.clone();for(;R.isBefore(O);)m[R.format(e)]=[],R.add(1,"day");let p=await Wt({calendarIds:[_],timeMin:E.toISOString(),timeMax:O.clone().add(1,"day").toISOString()}),{errors:g,busy:v}=p[_];return c&&c.length?{errors:g}:(Object.keys(m).forEach(f=>{let A=h(f).startOf("day").utcOffset(t,!0),L=h(f).endOf("day").utcOffset(t,!0),M=ut({busy:v,dateStart:A.toISOString(),dateEnd:L.toISOString()}).filter(({start:F})=>h(F).format(e)===f);m[f]=dt({free:M,serviceDuration:T,slotDuration:r}),I.isSame(A,"date")&&(u&&I.isSame(G,"date")?m[f]=m[f].filter(F=>F>=G.format("HH:mm")):m[f]=[])}),{professionalId:d,slots:m})}catch(t){return Qt.emit("error",t),{error:!0}}}function ut({dateStart:s,dateEnd:t,busy:n}){let{UTC_OFFSET:e}=V();s=h(s).utcOffset(e),t=h(t).utcOffset(e);let r=[],a=n.length,o=h(n[0].start).utcOffset(e);s.isBefore(o)&&r.push({start:s.toISOString(),end:o.toISOString()}),n.forEach((c,S)=>{let l=n[S+1]?.start;if(!l)return;let d=h(l).utcOffset(e),_=h(c.end).utcOffset(e);_.format("HH:mm")==="23:59"&&_.add(1,"minute"),_.isBefore(d)&&r.push({start:_.toISOString(),end:d.toISOString()})});let i=h(n[a-1].end).utcOffset(e);return i.isBefore(t)&&r.push({start:i.toISOString(),end:t.toISOString()}),r}function dt({free:s,serviceDuration:t,slotDuration:n}){let{UTC_OFFSET:e}=V(),r=[];return s.forEach(a=>{let o=h(a.start),i=h(a.end);for(;o.clone().add(t,"minutes").isSameOrBefore(i);)r.push(o.utcOffset(e).format("HH:mm")),o.add(n,"minutes")}),r}function ee({time:s,round:t}){let n=s.minute(),e=Math.ceil(n/t)*t;return e>=60?s.startOf("hour").add(1,"hour"):s.minute(e).second(0)}ft.exports={default:te,getCalendarFreePeriods:ut,getCalendarFreeTimeSlots:dt,roundTime:ee}});var St=C((Ue,Et)=>{var{events:se,getConfig:ne}=H();async function re({request:s}){try{let{EXTERNAL_FIELDS:t}=ne(),{body:n}=s,e=n.custom_fields,r=e[t.CLIENT_NAME]||n.name||null,a=e[t.CLIENT_PHONE]||n.whatsapp_phone||null,o={id:n.id,confirmed:!0,name:r,phone:a};return e[t.CLIENT_NAME]||(o.confirmed=!1),e[t.CLIENT_PHONE]||(o.confirmed=!1),o}catch(t){return se.emit("error",t),{error:!0}}}Et.exports={default:re}});var _t=C((He,Ot)=>{var k=require("moment"),{handleResources:ae}=q(),{events:oe,getConfig:ie}=H(),{manychatSetCustomFields:ce}=j(),{getGoogleCalendarsBusy:ue,appendGoogleSheetData:de,addGoogleCalendarEvent:fe}=$();async function le({request:s,arguments:t}){try{let{UTC_OFFSET:n,UTC_TIMEZONE:e,DATE_FORMAT:r,TIME_FORMAT:a,GOOGLESHEET_ID:o,GOOGLESHEET_TABS:i,GOOGLESHEET_FIELDS:c,MANYCHAT_FIELD_ID:S,CALENDAR_TITLE:l,CALENDAR_DESCRIPTION:d,GOOGLESHEET_SCHEDULE_FIELDS:_}=ie(),{body:T}=s,u=T.id,{client_id:E,professional_id:O,service_id:I,service_datetime:G,client_name:m,client_phone:R}=t,{errors:p,serviceSelected:g,professionalSelected:v}=await ae({arguments:t});if(p.length)return{errors:p};let f=R.replace("+",""),A=v[c.CALENDAR_ID],L=v[c.NAME],U=g[c.NAME],M=Number(g[c.DURATION]),F=Number(g[c.BEFORE_DURATION]),w=k(G,`${r} ${a}`).utcOffset(n,!0),gt=k().utcOffset(n);w.diff(gt,"minutes")<0&&p.push("Scheduling in the past is not allowed");let P=w.clone().add(M,"minutes"),Nt=w.clone().subtract(F,"minutes");if(w.diff(Nt,"minutes")<Number(F)&&p.push(`Minimum time is ${F} minutes in advance.`),(await ue({calendarIds:[A],timeMin:w.toISOString(),timeMax:P.toISOString()}))[A].busy.length&&p.push(`Professional unavailable at ${G} to `+P.format(`${r} ${a}`)),p.length)return{errors:p};let Y={service_name:U,client_name:m,client_phone:f},wt=l(Y),Ct=d(Y);await fe({calendarId:A,event:{summary:wt,description:Ct,start:{dateTime:w.format(),timeZone:e},end:{dateTime:P.format(),timeZone:e}}});let K=k().utcOffset(n).format(`${r} ${a}`),z=w.format(`${r} ${a}`),X=P.format(`${r} ${a}`),yt={CLIENT_ID:E,SERVICE_ID:I,PROFESSIONAL_ID:O,SERVICE_NAME:U,PROFESSIONAL_NAME:L,SERVICE_DATETIME_START:z,SERVICE_DATETIME_END:X,CLIENT_NAME:m,CLIENT_PHONE:f,CREATED_AT:K};return await de({spreadsheetId:o,range:i.SCHEDULES,values:[_.map(Dt=>yt[Dt]||"")]}),ce({subscriber_id:u,fields:[{field_id:S.CLIENT_NAME,field_name:"string",field_value:m},{field_id:S.CLIENT_PHONE,field_name:"string",field_value:f},{field_id:S.LAST_SCHEDULE_DATETIME,field_name:"string",field_value:w.toISOString()}]}),{success:!0,client_id:E,service_id:I,professional_id:O,service_name:U,professional_name:L,service_datetime_start:z,service_datetime_end:X,client_name:m,client_phone:f,created_at:K}}catch(n){return oe.emit("error",n),{error:!0}}}Ot.exports={default:le}});var mt=require("moment"),{googleApisHandler:Ee}=$(),{manychatHandler:Se,manychatSetCustomFields:Oe}=j(),{events:b,setConfig:_e,getConfig:At}=H(),{openAiHandler:me,createOpenAiThread:ht,addOpenAiThreadMessage:Tt,runOpenAiThread:he,getOpenAiAssistantRun:pt,getOpenAiRunMessages:Te,cancelOpenAiAssistantRun:pe,submitOpenAiAssistantOutput:Ae}=at(),Ie=q().default,ge=lt().default,Ne=St().default,we=_t().default;async function Ce(s,t){try{let{UTC_OFFSET:n,DATE_FORMAT:e,TIME_FORMAT:r,SECRETS:a,OPENAI_ASSISTANT_ID:o,EXTERNAL_FIELDS:i,THREAD_EXPIRATION:c,RUN_TRIES_MAX:S}=At(),{headers:l,body:d}=s;if(l.authorization!==process.env[a.API_KEY]){t.status(401).json("Unauthorized");return}me({apiKey:process.env[a.OPENAI_KEY]}),Se({apiKey:process.env[a.MANYCHAT_KEY]}),await Ee({serviceAccount:JSON.parse(process.env[a.GOOGLEAPIS_KEY])});let _=mt().utcOffset(n),T=d.custom_fields,u=T[i.THREAD_ID],E=T[i.RUN_ID],O={thread_id:u,run_id:E};if(E){if((await pt({threadId:u,runId:E})).status!=="completed"){b.emit("success",O),t.json(O);return}let{data:A}=await Te({threadId:u,runId:E}),L=A[0]?.content[0]?.text.value;O.message=L,b.emit("success",O),t.json(O);return}let I=T[i.LAST_MESSAGE_DATETIME];(I?_.diff(mt(I),"h"):0)>c&&(u=void 0),u||(u=(await ht()).id);let m=T[i.LAST_MESSAGE_TEXT];try{await Tt({threadId:u,message:m})}catch{u=(await ht()).id,await Tt({threadId:u,message:m})}O.thread_id=u,O.last_message_datetime=_.toISOString();let R="Data e hora atual de refer\xEAncia: "+_.format(`${e} ${r}`);E=(await he({threadId:u,instructions:R,assistantId:o})).id,O.run_id=E,t.json(O);let g=!0,v=0;for(;g;){v++;let f=await pt({threadId:u,runId:E});switch(f.status){case"requires_action":let A=f.required_action.submit_tool_outputs.tool_calls,U=(await Promise.all(A.map(M=>It({request:s,run:f,call:M})))).map(({callback:M})=>M);await Ae({threadId:u,runId:E,outputs:U});break;case"completed":g=!1;break;case"cancelled":g=!1;return;default:break}if(v===S)try{await pe({threadId:u,runId:E})}catch{}}b.emit("success",O)}catch(n){b.emit("error",n),t._headerSent||t.status(500).json("See logs")}}async function It({request:s,run:t,call:n}){let{FUNCTIONS_MAP:e}=At(),r={...e};e.GET_CATALOG&&(r[e.GET_CATALOG]=Ie),e.GET_CALENDAR&&(r[e.GET_CALENDAR]=ge),e.GET_CUSTOMER&&(r[e.GET_CUSTOMER]=Ne),e.SEND_SCHEDULE&&(r[e.SEND_SCHEDULE]=we);let{body:a}=s,{name:o,arguments:i}=n.function;i=JSON.parse(i);let c=r[o];if(!c)throw new Error("Function not found");let l=await c({request:s,run:t,name:o,arguments:i,setFields:_=>Oe({subscriber_id:a.id,fields:_.map(([T,u,E])=>({field_id:T,field_name:u,field_value:E}))})}),d={tool_call_id:n.id,output:JSON.stringify(l)};return{call:n,output:l,callback:d}}module.exports={assistantEvents:b,assistantConfig:_e,assistantHandler:Ce,assistantFunctionHandler:It};
